<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>地图编辑器</title>
		<link rel="stylesheet" type="text/css" href="css/mapEdit.css"/>
		<script src="js/developer.js"></script>
	</head>
	<body>
		<div style="padding: 10px;">
			<div class="map">
				<div>选择地图元件</div>
				<canvas id="map" width="320px" height="640px"></canvas>
			</div>
			<div class="echo">
				<div id="echoOperate">
					<input type="radio" name="layer" id="layer1" checked="checked" />
					<label for="layer1">图层1</label>
					<input type="radio" name="layer" id="layer2" />
					<label for="layer2">图层2</label>
					<input type="radio" name="tool" id="tool1" checked="checked" />
					<label for="tool1">默认</label>
					<input type="radio" name="tool" id="tool2" />
					<label for="tool2">笔刷</label>
				</div>
				<canvas id="echo" width="960px" height="640px"></canvas>
			</div>
		</div>
		<script type="text/javascript">
			var mapDOM = document.getElementById("map"),
				echoDOM = document.getElementById("echo");
			var mapPosition = { 
			    x: mapDOM.offsetLeft, 
				y: mapDOM.offsetTop 
			};
			var echoPosition = { 
			    x: echoDOM.offsetLeft, 
				y: echoDOM.offsetTop 
			};
			var map= mapDOM.getContext("2d"),
				echo= echoDOM.getContext("2d");
			//载入地图
			var img=new Image();
			img.src="img/tilesheet.png";
			img.onload = function (){
				var mapW = img.width,
					mapH = img.height;
				mapDOM.width = mapW,
				mapDOM.height = mapH;
				map.drawImage(img,0,0);
			}
			//载入地图 end
			var echoOperate = document.getElementById('echoOperate');
			var mouseStetus = 'default';
			echoOperate.addEventListener('click',function(e){
				var operateMap = {
					tool1 : function(){
						mouseStetus = 'default';
					},
					tool2 : function(){
						mouseStetus = 'paint';
					},
					default : function(){}
				};
				return (operateMap[e.target.id] || operateMap['default'])();
			})
			var mouseCoordinate = function(){
				var mapPaint = {
					paint : '',//画图用
					proto : '',//恢复用
					scrollX : 0,
					scrollY : 0,
					savePaint : function(canvas,x,y){
						this.paint = canvas.getImageData(selectArea.startX, selectArea.startY, x, y);
						//console.log(selectArea.startX, selectArea.startY, x, y)
						if(mapPaint.proto == ''){
							this.proto = canvas.getImageData(0, 0, mapDOM.width, mapDOM.height);
						}
					},
					putPaint : function(canvas,x,y){
						if(mapPaint.paint != ''){
							canvas.putImageData(this.paint,x,y);
						}else{
							console.log('未选取地图元件');
						}
					},
					clearBorder : function(canvas){
						if(mapPaint.proto != ''){
							canvas.putImageData(this.proto,0,0);
						}
					}
				};
				var selectArea = {
					startX : 0,
					startY : 0,
					endX : 0,
					endY : 0,
					record : function(x,y){
						this.startX = x;
						this.startY = y;
					},
					stop : function(x,y){
						this.endX = x;
						this.endY = y;
						//console.log(this)
					}
				};
				mapDOM.addEventListener('mousedown',function(e){
					var x = e.clientX + mapPaint.scrollX - mapPosition.x,
						y = e.clientY + mapPaint.scrollY - mapPosition.y;
					x = Math.floor(x/16)*16;
					y = Math.floor(y/16)*16;
					selectArea.record(x,y);
					mapPaint.clearBorder(map);
				});
				mapDOM.addEventListener('mouseup',function(e){
					var x = e.clientX + mapPaint.scrollX - mapPosition.x,
						y = e.clientY + mapPaint.scrollY - mapPosition.y;
					x = Math.floor(x/16)*16;
					y = Math.floor(y/16)*16;
					selectArea.stop(x,y);
					x = x - selectArea.startX +16;
					y = y - selectArea.startY +16;
					mapPaint.savePaint(map,x,y);
					map.strokeStyle="#FF0000";
					map.strokeRect(selectArea.startX,selectArea.startY,x,y);
				})
				mapDOM.parentNode.onscroll = function(){
					mapPaint.scrollY = this.scrollTop;
					mapPaint.scrollX = this.scrollLeft;
				}
				var press = function(e){
					var x = e.clientX - echoPosition.x,
						y = e.clientY - echoPosition.y;
						x = Math.floor(x/16)*16,
						y = Math.floor(y/16)*16;
					if(mouseStetus == 'paint'){
						mapPaint.putPaint(echo,x,y);
					}
				}
				echoDOM.addEventListener('click',press);
				echoDOM.addEventListener('mousedown',function(){
					echoDOM.addEventListener('mousemove',press);
					echoDOM.addEventListener('mouseup',function(){
						echoDOM.removeEventListener('mousemove',press);
					})
				});
			}();
		</script>
	</body>
</html>
