<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>地图编辑器</title>
		<script src="js/developer.js"></script>
		<style type="text/css">
			#echo{
				border: 1px solid #000;
				float: left;
			}
			#map{
				background-color: transparent;
				border: 1px solid #000;
				margin-right: 5px;
				float: left;
			}
		</style>
	</head>
	<body>
		<div style="padding: 10px;">
			<canvas id="map" width="320px" height="640px"></canvas>
			<canvas id="echo" width="960px" height="640px"></canvas>
		</div>
		<script type="text/javascript">
			var mapDOM = document.getElementById("map"),
				echoDOM = document.getElementById("echo");
			var mapPosition = { 
			    x: mapDOM.offsetLeft, 
				y: mapDOM.offsetTop 
			};
			var echoPosition = { 
			    x: echoDOM.offsetLeft, 
				y: echoDOM.offsetTop 
			};
			var map= mapDOM.getContext("2d"),
				echo= echoDOM.getContext("2d");
			//载入地图
			var img=new Image();
			img.src="img/tilesheet.png";
			img.onload = function (){
				var mapW = img.width,
					mapH = img.height;
				mapDOM.width = mapW,
				mapDOM.height = mapH;
				map.drawImage(img,0,0);
			}
			//载入地图 end
			var paint = {
				paint : '',
				proto : '',
				x : 0,
				y : 0,
				savePaint : function(canvas,x,y){
					this.paint = canvas.getImageData(x, y, 16, 16);
					this.proto = canvas.getImageData(x-2, y-2, 20, 20);
					this.x = x-2;
					this.y = y-2;
				},
				putPaint : function(canvas,x,y){
					if(paint.paint != ''){
						canvas.putImageData(this.paint,x,y);
					}else{
						console.log('未选取地图元件');
					}
				},
				clearBorder : function(canvas){
					canvas.putImageData(this.proto,this.x,this.y);
				}
			};
			mapDOM.addEventListener("click",function(e){
				var x = e.clientX - mapPosition.x,
					y = e.clientY - mapPosition.y;
				x = Math.floor(x/16)*16,
				y = Math.floor(y/16)*16;
				if(paint.paint != ''){
					paint.clearBorder(map);
				}
				paint.savePaint(map,x,y);
				map.strokeStyle="#FF0000";
				map.strokeRect(x,y,16,16);
			});
			var press = function(e){
				var x = e.clientX - echoPosition.x,
					y = e.clientY - echoPosition.y;
					x = Math.floor(x/16)*16,
					y = Math.floor(y/16)*16;
				paint.putPaint(echo,x,y);
			}
			echoDOM.addEventListener('click',press);
			echoDOM.addEventListener('mousedown',function(){
				echoDOM.addEventListener('mousemove',press);
				echoDOM.addEventListener('mouseup',function(){
					echoDOM.removeEventListener('mousemove',press);
				})
			})
		</script>
	</body>
</html>
